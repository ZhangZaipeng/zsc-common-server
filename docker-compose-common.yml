# 公共组件部署
# 基础组件eureka1、eureka2、config-server

version: "3.2"
services:
  zsc-eureka-1:
    # 镜像地址
    image: 123.207.79.123:5000/zsc-eureka:0.0.1-SNAPSHOT
    # 容器名称
    container_name: zsc-eureka-1
    ports:
      # 端口映射,这里单纯的是为了在外部能够访问eureka
      - "8761:8761"
    environment:
      # hostname URL
      - EUREKA_SERVICE_URL=http://zsc-eureka-1:8761/eureka/,http://zsc-eureka-2:8761/eureka/
      - HOSTNAME=zsc-eureka-1
      - LOGSTASH_HOST=logstash:4560
      - JAVA_OPTS=-Dspring.profiles.active=prod
    volumes:
      # 将宿主机上的文件挂载到容器内
      - type: "bind"
        source: /etc/localtime
        target: /etc/localtime
    # 集群部署下需要用到的参数
    deploy:
      # 实例数量
      replicas: 1
      # 更新选项
      placement:
        constraints:
          - node.role == worker
      update_config:
        # 每次更新多少个容器
        parallelism: 1
        # 间隔时间
        delay: 10s
      # 启动错误时，重新启动
      restart_policy:
        condition: on-failure
      resources:
        limits:
          # CPU限制
          cpus: '0.5'
          # 内存限制
          memory: 256M
  # 2、eureka2
  zsc-eureka-2:
    # 镜像地址
    image: 123.207.79.123:5000/zsc-eureka:0.0.1-SNAPSHOT
    # 容器名称
    container_name: zsc-eureka-2
    ports:
      # 端口映射
      - "8762:8761"
    environment:
      # hostname
      - EUREKA_SERVICE_URL=http://zsc-eureka-1:8761/eureka/,http://zsc-eureka-2:8761/eureka/
      - HOSTNAME=zsc-eureka-2
      - LOGSTASH_HOST=logstash:4560
      - JAVA_OPTS=-Dspring.profiles.active=prod
    volumes:
      # 将宿主机上的文件挂载到容器内
      - type: "bind"
        source: /etc/localtime
        target: /etc/localtime
    deploy:
      # 实例数量
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      # 更新选项
      update_config:
        # 每次更新多少个容器
        parallelism: 1
        # 间隔时间
        delay: 10s
      # 启动错误时，重新启动
      restart_policy:
        condition: on-failure
      resources:
        limits:
          # CPU限制
          cpus: '0.5'
          # 内存限制
          memory: 256M
  # 3、配置中心
  zsc-config:
    # 镜像地址
    image: 123.207.79.123:5000/zsc-config:0.0.1-SNAPSHOT
    # 容器名称
    container_name: zsc-config
    ports:
      # 端口映射
      - "8888:8888"
    environment:
      - PUBLIC_RABBITMQ_HOST=rabbitmq
      - PUBLIC_RABBITMQ_USERNAME=guest
      - PUBLIC_RABBITMQ_PASSWORD=guest
      - CONFIG_SERVER_SECURITY_NAME=tony
      - CONFIG_SERVER_SECURITY_PASSWORD=12345678
      - CONFIG_SERVER_ENCRYPT_KEY=12345678
      - EUREKA_SERVICE_URL=http://zsc-eureka-1:8761/eureka/,http://zsc-eureka-2:8761/eureka/
      - LOGSTASH_HOST=logstash:4560
      - JAVA_OPTS=-Dspring.profiles.active=prod
    # 在eureka容器之后启动
    depends_on:
      - zsc-eureka-1
      - zsc-eureka-2
    volumes:
      # 将宿主机上的文件挂载到容器内
      - type: "bind"
        source: /etc/localtime
        target: /etc/localtime
    deploy:
      # 实例数量
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      # 更新选项
      update_config:
        # 每次更新多少个容器
        parallelism: 1
        # 间隔时间
        delay: 10s
      # 启动错误时，重新启动
      restart_policy:
        condition: on-failure
      resources:
        limits:
          # CPU限制
          cpus: '0.5'
          # 内存限制
          memory: 256M